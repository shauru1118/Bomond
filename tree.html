<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞</title>
<style>
body { background:#0d1117; color:#e6edf3; font-family:'Segoe UI', sans-serif; padding:2rem; }
.nav a { color:#79c0ff; margin:0 10px; text-decoration:none; font-weight:bold; }
.nav a:hover { text-decoration:underline; }
.card { background:#161b22; padding:1.5rem; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.4); opacity:0; transform:translateY(30px); animation:fadeIn 1s forwards; max-width:900px; margin:auto; }
#tree { margin-top:1rem; font-family:monospace; line-height:1.6; }
.folder { font-weight:bold; cursor:pointer; color:#79c0ff; }
.file a { color:#c9d1d9; text-decoration:none; }
.file a:hover { text-decoration:underline; }
ul { list-style:none; margin:0; padding-left:1rem; border-left:1px dashed #30363d; }
li { margin:0.2rem 0; }
button { margin-left:5px; padding:2px 5px; font-size:0.8rem; cursor:pointer; border-radius:4px; border:none; background:#238636; color:white; }
button:hover { background:#2ea043; }
@keyframes fadeIn { to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>

<div class="nav">
  <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a> |
  <a href="upload.html">–ó–∞–≥—Ä—É–∑–∏—Ç—å</a> |
  <a href="view.html">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤</a> |
  <a href="tree.html">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞</a>
</div>

<div class="card">
  <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</h2>
  <div id="tree">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<input type="file" id="fileInput" style="display:none">

<script>
const API = 'http://127.0.0.1:5000';
const fileInput = document.getElementById('fileInput');

async function loadTree() {
    const treeDiv = document.getElementById('tree');
    try {
        const res = await fetch(`${API}/tree`);
        const data = await res.json();
        treeDiv.innerHTML = renderTree(data, '');
    } catch(e){
        treeDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e;
    }
}

function renderTree(node, path) {
    if(!node.children) return '';
    let html = '<ul>';
    for(const child of node.children){
        const childPath = path ? path+'/'+child.name : child.name;
        if(child.type === 'folder'){
            html += `<li>
                        <span class="folder" onclick="toggle(this)">üìÅ ${child.name}</span>
                        <button onclick="addFile('${childPath}')">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
                        <button onclick="addFolder('${childPath}')">–ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button>
                        ${renderTree(child, childPath)}
                     </li>`;
        } else {
            const url = `${API}${child.url}`;
            html += `<li class="file">üìÑ <a href="${url}" download>${child.name}</a></li>`;
        }
    }
    html += '</ul>';
    return html;
}

function toggle(el){
    const next = el.nextElementSibling;
    if(next && next.tagName==='UL') next.style.display = next.style.display==='none'?'block':'none';
}

function addFolder(folderPath){
    const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
    if(!name) return;
    fetch(`${API}/mkdir`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({path: folderPath, name})
    }).then(r => {
        if(r.ok) loadTree();
        else alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏");
    });
}

function addFile(folderPath){
    fileInput.onchange = async () => {
        const file = fileInput.files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append('to_upload', file);
        formData.append('folder', folderPath);
        const res = await fetch(`${API}/upload_to_folder`, {method:'POST', body:formData});
        if(res.ok) loadTree();
        else alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞");
    };
    fileInput.click();
}

loadTree();
</script>
</body>
</html>
