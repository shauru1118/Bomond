<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞</title>
<style>
body {
    background:#0d1117;
    color:#e6edf3;
    font-family:'Segoe UI', sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:2rem;
    text-align:center;
    margin:0;
}
.nav a {color:#79c0ff; margin:0 10px; text-decoration:none; font-weight:bold;}
.nav a:hover{text-decoration:underline;}
.card {
    background:#161b22;
    padding:2rem;
    border-radius:12px;
    box-shadow:0 0 20px rgba(0,0,0,0.4);
    max-width:900px;
    width:100%;
    margin-top:2rem;
}
h2 {margin-bottom:1rem;}
#breadcrumb {margin-bottom:1rem; font-size:0.9rem; color:#8b949e;}
#breadcrumb span{cursor:pointer; color:#79c0ff;}
#breadcrumb span:hover{text-decoration:underline;}
ul{list-style:none; margin:0; padding-left:1rem; border-left:1px dashed #30363d; overflow:hidden; transition:max-height 0.3s ease, opacity 0.3s ease; opacity:1; max-height:1000px;}
ul.collapsed{opacity:0; max-height:0;}
li{margin:0.2rem 0; opacity:0; transform:translateY(-10px); animation:fadeInUp 0.3s forwards;}
@keyframes fadeInUp{to{opacity:1; transform:translateY(0);}}
.folder{font-weight:bold; cursor:pointer; color:#79c0ff;}
.file a{color:#c9d1d9; text-decoration:none;}
.file a:hover{text-decoration:underline;}
button.icon{margin-left:5px; padding:0 5px; font-size:1rem; cursor:pointer; border-radius:4px; border:none; background:#238636; color:white;}
button.icon:hover{background:#2ea043;}
.back-btn{margin-left:10px; padding:0.2rem 0.5rem; background:#586069; color:white; border:none; border-radius:4px; cursor:pointer;}
.back-btn:hover{background:#444c56;}
</style>
</head>
<body>

<div class="nav">
  <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a> |
  <a href="view.html">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤</a> |
  <a href="tree.html">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞</a>
</div>

<div class="card">
  <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</h2>
  <div id="breadcrumb"></div>
  <div id="tree">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<input type="file" id="fileInput" style="display:none">

<script>
const API = 'https://bomond.pythonanywhere.com';
const fileInput = document.getElementById('fileInput');
let currentPath = '';

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ä–µ–≤–∞
async function loadTree(path=''){
    currentPath = path;
    renderBreadcrumb();
    try{
        const res = await fetch(`${API}/tree`);
        const data = await res.json();
        let node = data;
        if(currentPath){
            currentPath.split('/').forEach(p=>{
                if(!node.children) return;
                node = node.children.find(c=>c.type==='folder' && c.name===p);
            });
        }
        renderNode(node, document.getElementById('tree'));
    }catch(e){document.getElementById('tree').textContent='–û—à–∏–±–∫–∞: '+e;}
}

// Breadcrumb –∏ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
function renderBreadcrumb(){
    const bcDiv = document.getElementById('breadcrumb');
    let html = `<span onclick="loadTree()">–ö–æ—Ä–µ–Ω—å</span>`;
    if(currentPath){
        const parts = currentPath.split('/');
        html += ' / ' + parts.map((p,i)=>{
            const acc = parts.slice(0,i+1).join('/');
            return `<span onclick="loadTree('${acc}')">${p}</span>`;
        }).join(' / ');
    }
    bcDiv.innerHTML = html;

    if(currentPath){
        const backBtn = document.createElement('button');
        backBtn.className='back-btn';
        backBtn.textContent='–ù–∞–∑–∞–¥';
        backBtn.onclick = ()=>{
            if(!currentPath.includes('/')) loadTree('');
            else loadTree(currentPath.split('/').slice(0,-1).join('/'));
        };
        bcDiv.appendChild(backBtn);
    }
}

// –†–µ–Ω–¥–µ—Ä –ø–∞–ø–æ–∫ –∏ —Ñ–∞–π–ª–æ–≤
function renderNode(node, container){
    container.innerHTML='';
    if(!node || !node.children) return;
    const ul = document.createElement('ul');
    node.children.forEach(c=>{
        const childPath = currentPath ? currentPath+'/'+c.name : c.name;
        const li = document.createElement('li');

        if(c.type==='folder'){
            const span = document.createElement('span');
            span.className='folder';
            span.textContent='üìÅ '+c.name;
            span.onclick=()=>{
                if(li.querySelector('ul')){
                    li.querySelector('ul').classList.toggle('collapsed');
                }else{
                    fetch(`${API}/tree`).then(r=>r.json()).then(data=>{
                        let subNode = data;
                        childPath.split('/').forEach(p=>{
                            if(!subNode.children) return;
                            subNode = subNode.children.find(x=>x.type==='folder' && x.name===p);
                        });
                        if(subNode) renderNode(subNode, li.appendChild(document.createElement('div')));
                        const innerUl = li.querySelector('div').firstChild;
                        if(innerUl) li.replaceChild(innerUl, li.querySelector('div'));
                    });
                }
            };
            li.appendChild(span);

            // –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            const addFileBtn = document.createElement('button');
            addFileBtn.className='icon';
            addFileBtn.textContent='üìé';
            addFileBtn.title='–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª';
            addFileBtn.onclick = (e)=>{
                e.stopPropagation();
                addFile(childPath);
            };
            li.appendChild(addFileBtn);

            // –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞–ø–∫–∏
            const addFolderBtn = document.createElement('button');
            addFolderBtn.className='icon';
            addFolderBtn.textContent='üìÇ+';
            addFolderBtn.title='–ù–æ–≤–∞—è –ø–∞–ø–∫–∞';
            addFolderBtn.onclick = (e)=>{
                e.stopPropagation();
                addFolder(childPath);
            };
            li.appendChild(addFolderBtn);

            // –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞–ø–∫–∏
            const delBtn = document.createElement('button');
            delBtn.className='icon';
            delBtn.textContent='üóëÔ∏è';
            delBtn.title='–£–¥–∞–ª–∏—Ç—å';
            delBtn.onclick = (e)=>{
                e.stopPropagation();
                deleteItem(childPath);
            };
            li.appendChild(delBtn);

        }else{
            const a = document.createElement('a');
            a.href=`${API}/files/${childPath}`;
            a.download=c.name;
            a.className='file';
            a.textContent='üìÑ '+c.name;
            li.appendChild(a);

            const delBtn = document.createElement('button');
            delBtn.className='icon';
            delBtn.textContent='üóëÔ∏è';
            delBtn.title='–£–¥–∞–ª–∏—Ç—å';
            delBtn.onclick = (e)=>{e.stopPropagation(); deleteItem(childPath);};
            li.appendChild(delBtn);
        }

        ul.appendChild(li);
    });
    container.appendChild(ul);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏
function addFolder(path){
    const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
    if(!name) return;
    fetch(`${API}/mkdir`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({path:name ? path : '', name})
    }).then(r=>{if(r.ok) loadTree(currentPath); else alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏");});
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
function addFile(path){
    fileInput.onchange = async ()=>{
        const file = fileInput.files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append('to_upload',file);
        formData.append('folder',path);
        const res = await fetch(`${API}/upload_to_folder`,{method:'POST',body:formData});
        if(res.ok) loadTree(currentPath); else alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞");
    };
    fileInput.click();
}

// –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
function deleteItem(path){
    if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å?")) return;
    fetch(`${API}/delete`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({path})
    }).then(r=>{if(r.ok) loadTree(currentPath); else alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");});
}

// –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
loadTree();
</script>
</body>
</html>
